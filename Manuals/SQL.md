# SQL

**Реляционная база данных** состоит из двумерных таблиц *(строка и столбец)* информации.  
**Строки** таблицы называются **записями**.  
**Столбцы (fields)** таблицы называются **полями**. Они именуются и упорядочиваются.  
**Первичные ключи (primary key)** - уникальные идентификаторы каждой записи таблицы *(уникальный столбец или группа столбцов)*.  
**Предикат** - условие определяемое **WHERE**, которое может быть верным или неверным для любой строки таблицы.  
**DDL (Язык Определения Данных)** - так называемый Язык Описания Схемы в ANSI, состоит из команд которые создают объекты 
( таблицы, индексы, просмотры, и так далее ) в базе данных.  
**DML (Язык Манипулирования Данными)** - это набор команд которые определяют какие значения представлены в таблицах в любой момент времени.  
**DCD (Язык Управления Данными)** - состоит из средств которые определяют, разрешить ли пользователю выполнять определенные действия или нет.  
*Интерактивный SQL* используется для выполнения действий в базе данный, а *Встроеннный SQL*в различных языках программирования для обращений к базе данных.
***
Основные типы данных, определенные в ANSI:
* **INTEGER (INT)** - целое чило  
* **DECIMAL (DEC)** - вещественное число   
* **DATA** - дата
* **CHAR** - строка текста. Поле типа CHAR имеет определенную длину, которая определяется максимальным числом символов которые могут быть введены в это поле.  
* **VARCHAR** - является текстовой строкой которая может иметь любую длину до определенного реализацией максимума (обычно 254 символа ).  
*CHARACTER* и *VARCHAR* значения включаются в одиночные кавычки как например **'текст'**. Различие между *CHAR* и *VARCHAR* в том, что *CHAR* должен резервировать достаточное 
количество памяти для максимальной длины строки, а *VARCHAR* выделяет память по мере необходимости.
***
Специальное значение **USER** может использоваться как аргумент в команде. Он
обозначает авторизационный ID пользователя, дающего команду.  
***
Все запросы в SQL конструируются вокруг одной команды - **SELECT**.  

**SELECT** *sname1*, *sname2* **FROM** *table*;  
* **SELECT** - ключевое слово, которое сообщает базе данных, что команда является запросом.  
* ***sname*** - список столбцов, которые должны быть предоставлены по выполнению запроса.  
* **FROM** - ключевое слово, которое должно быть представлено в каждом запросе.
За ним следует имя таблицы, которая используется как источник информации для запроса.  
* **;** - используется во всех интерактивных командах SQL для сообщения базе данных, что команда
сформулирована и готова к выполнению. В некоторых системах этот символ заменен на символ "слэш обратный" ("\\") в строке,
которая непосредственно следует за концом команды.  
***
**SELECT** __*__ **FROM** *table*; - вывести все столбцы таблицы.  
***
**SELECT** **DISTINCT** __*__ **FROM** *table*;
* **DISTINCT** - исключает дублирующиеся значения строк из списка выходных данных.  
* **ALL** - наоборот включает дублирующиеся результаты в список. По умолчанию считается, что стоит **ALL**
***
**SELECT** *sname* **FROM** *table* **WHERE** *sname*='city';
* **WHERE** определяет *предикат* - условие, которое может быть истинным или ложным для каждой строки.  
* **AND, OR, NOT** - могут использоваться в условиях   
***
##Специальные операторы.  

Вместо подобного перечисления условий:  
**SELECT** __*__ **FROM** *table* **WHERE** *city*='London' **OR** *city*='Barcelona';  
Можно использовать следующий вариант:  
**SELECT** __*__ **FROM** *table* **WHERE** *city* **IN** ('London', 'Barcelona');  
* **IN** полностью определяет множество, которому данное значение может принадлежать или не принадлежать.
Выполняется, если значение равно хотя бы одному элементу множества.  
***
**SELECT** __*__ **FROM** *table* **WHERE** *snum* **BETWEEN** 4 **AND** 8;  
**BETWEEN** ... **AND**... - задает границы, в которые должно попадать значение. Границы включены.
В нем можно указывать диапазон чисел или букв (алфавитный диапазон, у него не попадают крайние элементы).  
***
**SELECT** __*__ **FROM** *table* **WHERE** (*sum* **BETWEEN** 7 **AND** 10) 
**AND** **NOT** *sum* **IN** (7, 10) - исключающее множество, в которое не входят границы.  
***
 **LIKE** применим только к полям типа **CHAR** или **VARCHAR**, поскольку он используется для поиска подстрок. Он осуществляет просмотр строки для
выяснения: входит ли заданная подстрока в указанное поле. С этой же целью используются шаблоны - специальные 
символы, которые могут обозначать все, что угодно.  
Существует два типа шаблонов, используемых с **LIКE**:  
* Символ "подчеркивание" ( **_** ) заменяет один любой символ. Например, образцу
'b_t' соответствуют 'bаt' или 'bit', но не соответствует 'brat'. 
* Символ "процент" ( **%** ) заменяет последовательность символов произвольной
длины, в том числе и нулевой. Например, образцу '%p%t' соответствуют 'put',
'posit', 'opt', но не 'spite'.  
**LIКE** может оказаться полезным при осуществлении поиска имени или другого
значения, полное написание которого неизвестно.  

**SELECT** __*__ **FROM** *table* **WHERE** *sname* **LIKE** 'G%';  

***
Специальные операторы (**IS**, **LIKE**, **BEETWEN**, **IN**, **LIKE**) могут непосредственно предшествовать булеву оператору 
**NOT**. Этим они отличаются от операторов сравнения, которые должны содержать **NOT** перед всем выражением.  

**SELECT** __*__ **FROM** *Customers* **WHERE** *city* **IS NOT NULL;**  
Эквивалентно следующему:  
**SELECT** __*__ **FROM** *Customers* **WHERE** **NOT** *city* **IS NULL;**  

**SELECT** __*__ **FROM** *Salespeople* **WHERE** *city* **NOT IN** (*'London', ·san Jose'*);
<=>  
**SELECT** __*__ **FROM** *Salespeople* **WHERE** **NOT** *city* **IN** (*'London' , 'San Jose'*);  

***
 ##Функции агрегирования.  
 
* **COUNT** определяет количество строк или значений поля, выбранных посредством запроса и не являющихся **NULL**-значениями.
* **SUM** вычисляет арифметическую сумму всех выбранных значений данного
поля.
* **АVG** вычисляет среднее значение для всех выбранных значений данного поля.
* **МАХ** вычисляет наибольшее из всех выбранных значений данного поля.
* **MIN** вычисляет наименьшее из всех выбранных значений данного поля.  

Функции агрегирования используются как имена полей в предложении запроса **SELECT** с одним исключением: имена полей 
применяются как аргументы.  
Для **SUM** и **AVG** могут использоваться только цифровые поля. Для **COUNT, МАХ** и **MIN** - цифровые и символьные поля.  
***
Сумма всех заявок из таблицы *Orders*:  
**SELECT SUM**(*amt*) **FROM** *Orders*;  

***
 Функция **COUNT** отличается от предыдущих тем, что подсчитывает количество значений в данном столбце или количество 
 строк в таблице. Когда подсчитываются значения по столбцу, в команде используется **DISTINCT** для подсчета числа 
 различных значений данного поля.  
 
 **SELECT** **COUNT** (**DISTINCT** *snum*) **FROM** *Orders*;  
 
 **DISТINCT** можно применять с любой функцией агрегирования, но чаще всего он используется с **COUNT**.  
 Для подсчета общего количества строк в таблице следует использовать функцию **COUNT** со звездочкой вместо имени поля.  
 
 **SELECT** **COUNT** (__*__) **FROM** *Customers*; - подсчет общего количества строк в таблице *Customers*.  

Различие между **ALL** и __*__ при использовании **COUNT** заключается в следующем:
* **ALL** использует имя поля в качестве аргумента.
* **ALL** не подсчитывает **NULL**-значения.  
 
**SELECT COUNT** (**ALL** *rating*) **FROM** *Customers*; - подсчет количества значений поля *rating*, отличных от 
**NULL**-значений, в таблице *Customers* (включая повторения).  

***
Агрегатные функции можно использовать с аргементами, состоящими из нескольких полей:  

**SELECT МАХ** (*binc + amt*) **FROM** *Orders*;  

***
**GROUP BY** группирует по полям, имеющим одинаковые значения.

**SELECT** *snum*, **MAX**(*amt*) **FROM** *Orders* **GROUP ВY** *snum*; -  наибольший заказ из тех, что получил каждый 
из продавцов.

**GROUP BY** применяет агрегатные функции отдельно к каждой серии групп, которые определяются общим значением поля. 
В данном случае каждая группа состоит из всех тех строк, которые имеют одно и то же значение *snum*, а функция **МАХ** 
применяется отдельно к каждой такой группе. Это означает, что поле, к которому применяется
**GROUP BY** по определению имеет на выходе только одно значение на каждую группу, что соответствует применению 
агрегатных функций.  

**Двойная группировка**: группировка данных таблицы *Orders* по дате (*odate*) внутри одного и того же поля **snum** и применить функцию **МАХ**
к каждой группе.  
   
 **SELECT** *snum*, *odate*, **MAX**(*amt*) **FROM** *Orders* **GROUP ВY** *snum*, *odate*;  
 
***
 
Использовать *агрегатные функции* в предложении **WHERE** **нельзя** поскольку предикаты оцениваются в терминах единственной
строки, тогда как агрегатные функции оцениваются в терминах групп строк.  

Покупки превышающие 3000 сгруппированные по датам у сгруппированных продавцов:  
**! ! ! НЕЛЬЗЯ! ! !:**  
**SELECT** *snum, odate*, **MAX**(*amt*) **FROM** *Orders* **WHERE MAX**(*amt*) > 3000.00 **GROUP ВY** *snum, odate*;  

***! ! ! МОЖНО ! ! !:**  
**SELECT** *snum, odate*, **MAX**(*amt*) **FROM** *Orders* **GROUP ВY** *snum, odate* **HAVING MAX**(*amt*) > 3000.00;  

* **HAVING** -  определяет критерий, согласно которому определенные группы исключаются из числа выходных данных, так же,
как предложение **WHERE** делает это для отдельных строк. Аргументы **HAVING** подчиняются тем же правилам, что и 
аргументы **SELECT** в команде, использующей **GROUP ВY**, и должны иметь единственное значение для каждой выходной группы.   
**HAVING** должно относиться только к агрегатам и полям, выбранным по **GROUP ВY**.  

"Вот наибольшие заявки на 3 октября":  
**SELECT** *snum*, **MAX**(*amt*) **FROM** *Orders* **WHERE** *odate* = 10/03/1990
**GROUP BY** *snum*;  

**HAVING** может иметь только такие аргументы, у которых единственное значение для группы выходных данных. На практике 
чаще всего применяются агрегатные функции, но можно осуществлять выбор полей и с помощью **GROUP ВY**. Например, можно 
взглянуть на самые большие заказы для Serres и Rifkin:  

**SELECT** *snum*, **MAX**(*amt*)  
**FROM** *Orders*  
**GROUP ВY** *snum*  
**HAVING** *snum* **IN** (1002, 1007)  

Агрегатные функции применимы к группам значений, определяемым предложением **GROUP ВY**. Эти группы имеют общее значение
поля и могут использоваться внутри других групп, имеющих общее значение поля. Предикаты нужны для определения строк, 
к которым применяется функция агрегирования. Вы можете задать условие исключения определенных результирующих
групп с помощью предложения **HAVING**.  

***
Все заявки от 10 марта 1990:  

**SELECT** **COUNT** ( __*__ )  
**FROM** *Orders*  
**WHERE** *odate* = 10/03/1990;  

***
Количество различных городов (не **NULL**) в таблице *Customers*:
  
**SELECT COUNT** (**DISTINCT** *city*)  
**FROM** *Customers*;  

***
Запрос, который выбирает первого в алфавитном порядке покупателя, имя которого начинается с 'G':

**SELECT MIN** (*cname*)  
**FROM** *Customers*  
**WHERE** *cname* **LIKE** 'G%';   

***
Запрос, который выбирает максимальный рейтинг (rating) для каждого города:  

**SELECT** *city*, **МАХ** (*rating*)  
**FROM** *Customers*  
**GROUP ВY** *city*;  
  
***
